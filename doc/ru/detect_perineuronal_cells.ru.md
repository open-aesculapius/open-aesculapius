# Детектирование ячеек перинейрональной сети [![en](https://img.shields.io/badge/en-ru-green.svg)](../en/detect_perineuronal_cells.md)
Данный файл содержит описание метода детектирования ячеек

# Основная идея
Алгоритм работы модуля: 
1. Импорт необходимых библиотек: 
- Torch, torchvision – для работы с нейронными сетями и преобразованиями изображений. 
- OpenCV – для работы с изображениями. 
- NumPy – для выполнения численных и статистических вычислений, а также для работы с многомерными массивами. Чтение конфигурации запуска. Функция «calculate_perineuronal_cell_depth()», предназначенная для демонстрации модуля, загружает параметры работы из словаря и входные изображения. Параметры включают используемое устройство (CPU или GPU), путь к весам обученной модели в формате «.pkl».
- Albumentations – для преобразований данных.
2. Инициализация модели TransformerVGG. Весовые коэффициенты для модели загружаются из предварительно обученного файла весов, указанного в конфигурационном файле. Модель переводится на указанное устройство (CPU или GPU), а также инициализируются преобразования, которые будут проводиться с изображениями. Преобразования включают в себя конвертацию в тензоры и нормализацию с серединой 0.5 и стандартным отклонением 0.5 по умолчанию.
3. Предобработка данных. Метод «_preprocess_data()» объединяет слои изображений в один объем, применяет преобразования и готовит данные для инференса.
4. Обработка изображений с помощью модели TransformerVGG. После предобработки изображения подаются на вход модели, где происходит карты вероятности. Для каждой позиции i, j стека вычисляется уверенность модели в существовании ячейки. Прогнозирование выполняется в режиме без градиентов с помощью методы «torch.no_grad()», что оптимизирует вычисления и снижает нагрузку на устройство.
Постобработка результатов. Метод «_postprocess_data()» применяется к выходу модели для извлечения координат обнаруженных ячеек.

# Демонстрация
Для демонстрации работы модуля используется пример `simple_detect_perineural_cells.py`, расположенный по следующему пути:
```
<корень_проекта>/examples/simple_detect_perineural_cells.py
```
Демонстрационный набор данных находится по следующему пути: 
```
<корень_проекта>/data/microscopic/perineural/stack_layers
```

Ниже представлен исходный стак изображений, который использовался в качестве входных данных:

![raw detect perineuronal cells](/doc/assets/raw_detect_perineuronal_cells.png)    

Результат работы модуля:

![result detect perineuronal cells](/doc/assets/result_detect_perineuronal_cells.png)
